<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>#HUMANITY Universe</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { background:#fff; color:#202020; font-family:'Merriweather',serif; text-align:center; padding:20px; position:relative; }
    .top-right { position:absolute; top:16px; right:16px; background:#000; color:#fff; border:none; border-radius:6px; padding:8px 16px; cursor:pointer; font-family:'Merriweather',serif; transition:background .2s; }
    .top-right:hover { background:#333; }
    h1 { font-family:'Playfair Display',serif; font-size:2.4rem; margin:16px 0; }
    #globeCanvas { display:block; margin:0 auto 16px; width:90vw; max-width:380px; height:380px; }
    #openModal { background:#000; color:#fff; border:none; border-radius:6px; padding:12px 32px; font-size:1rem; cursor:pointer; margin-bottom:16px; font-family:'Merriweather',serif; transition:background .2s; }
    #openModal:hover { background:#333; }
    .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999; }
    .modal.show { display:flex; }
    .modal-content { background:#fff; padding:24px; border-radius:12px; max-width:360px; width:90vw; text-align:left; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
    .modal-content h2 { font-family:'Playfair Display',serif; margin-top:0; margin-bottom:12px; }
    .modal-content textarea { width:100%; min-height:80px; padding:8px; border:1px solid #ccc; border-radius:6px; resize:vertical; font-family:'Merriweather',serif; }
    .modal-content input[type=file] { margin:12px 0; width:100%; }
    #imagePreview { max-width:100%; display:none; margin-bottom:12px; border-radius:6px; }
    .file-info { font-size:0.85rem; color:#555; margin-bottom:8px; }
    .modal-actions { text-align:right; }
    .modal-actions button { font-family:'Merriweather',serif; padding:8px 20px; border:none; border-radius:6px; margin-left:8px; cursor:pointer; }
    #postButton { background:#000; color:#fff; }
    #postButton:hover { background:#333; }
    #closeModal { background:#fff; color:#000; border:1px solid #ccc; }
    #closeModal:hover { background:#e0e0e0; }
    #postsContainer { margin:24px auto; max-width:600px; text-align:left; }
    .post-item { background:#f0f0f0; border:1px solid #ccc; border-radius:12px; padding:16px; margin-bottom:20px; display:flex; gap:12px; align-items:flex-start; }
    .avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; }
    .post-content { flex:1; }
    .post-content .username { font-weight:700; margin-right:8px; }
    .post-content .timestamp { font-size:.85rem; color:#555; }
    .post-content .text { margin:8px 0; }
    .uploaded { max-width:200px; margin-top:8px; border-radius:6px; }
  </style>
</head>
<body>
  <button class="top-right" id="logoutBtn">Logout</button>
  <button class="top-right" style="right:120px;" id="profileBtn">Profile</button>
  <h1>The Universe</h1>
  <canvas id="globeCanvas" width="400" height="400"></canvas>
  <button id="openModal" type="button">üìù New Post</button>
  <div id="postModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h2>Feed the Human Feed‚Ä¶</h2>
      <textarea id="postText" placeholder="What‚Äôs on your mind?"></textarea>
      <input type="file" id="postImage" accept="image/*">
      <img id="imagePreview" alt="Image Preview">
      <div class="modal-actions">
        <button id="postButton" type="button">Post</button>
        <button id="closeModal" type="button">Cancel</button>
      </div>
    </div>
  </div>
  <div id="postsContainer"></div>

  <script>
    const MAX_FILE_SIZE = 5 * 1024 * 1024;
    const firebaseConfig = {
      apiKey: "AIzaSyBT7P7DAfV-I9ESe6f9Jdp5ioCyGIK0d9A",
      authDomain: "hashhumanity-58b9a.firebaseapp.com",
      databaseURL: "https://hashhumanity-58b9a-default-rtdb.firebaseio.com",
      projectId: "hashhumanity-58b9a",
      storageBucket: "hashhumanity-58b9a.appspot.com",
      messagingSenderId: "886745899016",
      appId: "1:886745899016:web:2b0f7e0434379d71bd"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();
    let currentUserProfile = null;

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = 'login.html';
      const snap = await db.ref(`users/${user.uid}`).once('value');
      currentUserProfile = snap.val();
      if (!currentUserProfile) return window.location.href = 'create_profile.html';
      setupPostModal();
      listenForPosts();
    });

    document.getElementById('logoutBtn').onclick = async () => {
      await auth.signOut();
      window.location.href = 'login.html';
    };

    document.getElementById('profileBtn').onclick = () => {
      window.location.href = 'view_profile.html';
    };

    function setupPostModal() {
      const openBtn = document.getElementById('openModal');
      const modal = document.getElementById('postModal');
      const closeBtn = document.getElementById('closeModal');
      const preview = document.getElementById('imagePreview');
      const txt = document.getElementById('postText');
      const fileInp = document.getElementById('postImage');
      const postBtn = document.getElementById('postButton');

      openBtn.onclick = () => {
        modal.classList.add('show');
        preview.style.display = 'none';
        txt.value = '';
        fileInp.value = '';
      };
      closeBtn.onclick = () => modal.classList.remove('show');

      fileInp.onchange = () => {
        const img = fileInp.files[0];
        if (img) {
          if (img.size > MAX_FILE_SIZE) {
            alert('Image too large! Max 5MB.');
            fileInp.value = '';
            preview.style.display = 'none';
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            preview.src = reader.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(img);
        } else {
          preview.style.display = 'none';
        }
      };

      postBtn.onclick = async () => {
        const content = txt.value.trim();
        const imgFile = fileInp.files[0];
        if (!content && !imgFile) return alert('Enter text or choose an image.');

        postBtn.disabled = true;

        try {
          let imageUrl = '';
          if (imgFile) {
            const path = `postImages/${auth.currentUser.uid}_${Date.now()}_${imgFile.name}`;
            const snap = await storage.ref().child(path).put(imgFile);
            imageUrl = await snap.ref.getDownloadURL();
          }

          const postData = {
            uid: auth.currentUser.uid,
            username: currentUserProfile?.username || 'Anonymous',
            avatar: currentUserProfile?.avatar || '',
            content,
            imageUrl,
            timestamp: Date.now(),
            likes: 0
          };

          await db.ref('posts').push(postData);

          modal.classList.remove('show');
          txt.value = '';
          fileInp.value = '';
          preview.style.display = 'none';

        } catch (e) {
          alert('Failed to post: ' + e.message);
        } finally {
          postBtn.disabled = false;
        }
      };
    }

    function listenForPosts() {
      const container = document.getElementById('postsContainer');
      db.ref('posts').orderByChild('timestamp').on('value', snapshot => {
        container.innerHTML = '';
        snapshot.forEach(child => {
          const p = child.val();
          const div = document.createElement('div');
          div.className = 'post-item';
          const avatar = document.createElement('img');
          avatar.className = 'avatar';
          avatar.src = p.avatar || 'https://via.placeholder.com/48';
          div.appendChild(avatar);
          const cd = document.createElement('div');
          cd.className = 'post-content';
          cd.innerHTML = `
            <span class="username">${p.username}</span>
            <span class="timestamp">${new Date(p.timestamp).toLocaleString()}</span>
            <div class="text">${p.content.replace(/</g,'&lt;')}</div>
            ${p.imageUrl ? `<img class="uploaded" src="${p.imageUrl}">` : ''}
          `;
          div.appendChild(cd);
          container.prepend(div);
        });
      });
    }

    // Simple globe render (optional)
    const canvas = document.getElementById('globeCanvas');
    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
    renderer.setSize(400, 400);
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
    camera.position.z = 3;
    const loader = new THREE.TextureLoader();
    const earthTex = loader.load('https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg');
    const sphere = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), new THREE.MeshStandardMaterial({ map: earthTex }));
    scene.add(sphere);
    const light = new THREE.DirectionalLight(0xffffff, 1.2);
    light.position.set(5, 3, 5);
    scene.add(light);
    (function animate() {
      requestAnimationFrame(animate);
      sphere.rotation.y += 0.002;
      renderer.render(scene, camera);
    })();
  </script>
</body>
</html>
