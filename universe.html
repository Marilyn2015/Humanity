<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>#HUMANITY Universe</title>
  <!-- Firebase & Three.js -->
  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #080c19;
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      text-align: center;
    }
    #star-bg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 0;
      background: transparent;
    }
    .globe-glow {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 32px auto 16px auto;
      width: 400px; height: 400px;
      position: relative;
      z-index: 2;
    }
    #globeCanvas {
      width: 400px; height: 400px;
      border-radius: 0 !important;
      background: transparent;
      display: block;
      position: absolute;
      left: 0; top: 0; z-index: 2;
      box-shadow: none;
    }
    h1 {
      font-size: 2.3rem;
      color: #fff;
      letter-spacing: 2px;
      margin: 0 0 24px 0;
      z-index: 2;
      position: relative;
      border-radius: 0 !important;
    }
    .post-item {
      background: #18181b;
      border: 1px solid #222;
      padding: 18px 24px 16px 24px;
      margin: 16px auto;
      width: 75%;
      max-width: 340px;
      border-radius: 0 !important;
      text-align: left;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 18px #00f6ff7a, 0 2px 16px #000b;
      position: relative;
      gap: 6px;
      transition: width 0.3s, max-width 0.3s;
      z-index: 2;
    }
    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 0 !important;
    }
    .post-item img.avatar {
      width: 46px;
      height: 46px;
      border-radius: 0 !important;
      border: 2px solid #333;
      object-fit: cover;
    }
    .post-user {
      font-weight: bold;
      font-size: 1.07rem;
      letter-spacing: 0.5px;
      border-radius: 0 !important;
    }
    .post-date {
      color: #aaa;
      font-size: 0.87rem;
      margin-left: 4px;
      font-weight: normal;
      border-radius: 0 !important;
    }
    .post-item img.uploaded {
      max-width: 100%;
      border-radius: 0 !important;
      margin-top: 10px;
      border: 1px solid #222;
      box-shadow: 0 0 8px #00e4fa66, 0 0 3px #0007;
    }
    .modal-blur {
      display: none;
      position: fixed;
      z-index: 900;
      inset: 0;
      background: rgba(10,30,44,0.56);
      backdrop-filter: blur(8px);
      border-radius: 0 !important;
    }
    .modal-blur.active { display: block; border-radius: 0 !important; }
    .modal {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: fixed;
      z-index: 1000;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      background: #222e3e;
      color: #fff;
      padding: 38px 34px 28px 34px;
      min-width: 350px;
      border: 2px solid #fff;
      box-shadow: 0 0 40px 14px #fff9, 0 8px 60px #0029, 0 2px 24px #000b;
      outline: none;
      transition: box-shadow 0.3s, background 0.2s, opacity 0.2s;
      border-radius: 0 !important;
    }
    .modal.active {
      display: flex;
      animation: modalIn 0.17s cubic-bezier(.17,.67,.49,1.41);
      border-radius: 0 !important;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: translate(-50%, -60%) scale(0.92);}
      to   { opacity: 1; transform: translate(-50%, -50%) scale(1);}
    }
    textarea {
      width: 260px;
      height: 70px;
      margin: 12px 0;
      padding: 10px;
      border: 1.5px solid #fff;
      border-radius: 0 !important;
      background: #18181b;
      color: #fff;
      font-size: 1rem;
      resize: vertical;
      box-shadow: 0 2px 16px #fff7, 0 0 4px #fff3;
      outline: none;
    }
    input[type='file'] {
      margin: 8px 0;
      color: #fff;
      filter: drop-shadow(0 0 8px #fff8);
      border-radius: 0 !important;
    }
    button, .like-btn, .delete-btn {
      padding: 10px 28px;
      border: none;
      background: linear-gradient(90deg, #fff 0%, #e9e9e9 100%);
      color: #191919;
      border-radius: 0 !important;
      font-weight: 600;
      letter-spacing: 1px;
      font-size: 1.08rem;
      margin: 6px 10px 0 0;
      box-shadow: 0 0 20px 4px #ffffffd0, 0 2px 16px #0009;
      cursor: pointer;
      transition: 0.22s background, 0.2s color, 0.17s box-shadow, 0.2s transform;
      position: relative;
    }
    button:hover, .like-btn:hover, .delete-btn:hover {
      background: linear-gradient(90deg, #fff 0%, #ffbdbd 100%);
      color: #a20000;
      box-shadow: 0 0 32px 7px #fff, 0 4px 10px #fff4, 0 2px 16px #1000;
      outline: 0;
    }
    .top-left, .top-right, #openModal {
      box-shadow: 0 0 32px 8px #fff8, 0 2px 10px #0008;
      border-radius: 0 !important;
      padding: 9px 24px;
      font-size: 1.08rem;
      z-index: 10;
    }
    .top-left { left: 16px; top: 16px; position: absolute; z-index: 200; }
    .top-right { right: 16px; top: 16px; position: absolute; z-index: 200; }
    #openModal {
      margin: 0 auto 28px auto;
      display: block;
      font-weight: 700;
      font-size: 1.22rem;
      border-radius: 0 !important;
    }
    .post-actions {
      margin-top: 7px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 0 !important;
    }
    .like-btn, .delete-btn {
      padding: 10px 20px;
      background: linear-gradient(90deg, #fff 0%, #ededed 100%);
      color: #18181b;
      border-radius: 0 !important;
      box-shadow: 0 0 14px 3px #fff9, 0 2px 8px #0008;
      font-size: 1.22rem;
      transition: 0.16s all;
      border: none;
      outline: none;
    }
    .like-btn.liked {
      background: linear-gradient(90deg, #fff 0%, #fff 100%);
      color: #e81c4f;
      font-weight: bold;
      text-shadow: 0 0 16px #fff, 0 0 6px #e81c4f77;
      box-shadow: 0 0 32px 12px #fff, 0 2px 14px #fff3;
      outline: 0;
      border-radius: 0 !important;
    }
    .delete-btn:hover {
      background: linear-gradient(90deg, #fff 0%, #ffbdbd 100%);
      color: #a20000;
      box-shadow: 0 0 32px 7px #fff, 0 4px 10px #fff4, 0 2px 16px #1000;
      outline: 0;
      border-radius: 0 !important;
    }
    .error-banner {
      background: #ff6870;
      color: #fff;
      font-weight: 600;
      padding: 8px 0;
      margin-bottom: 10px;
      width: 100%;
      border-radius: 0;
      display: none;
    }
  </style>
</head>
<body>
  <canvas id="star-bg"></canvas>
  <div class="error-banner" id="errorBanner"></div>
  <button class="top-left" onclick="window.location.href='view_profile.html'">My Profile</button>
  <button class="top-right" onclick="window.location.href='login.html'">Logout</button>
  <div class="globe-glow">
    <canvas id="globeCanvas"></canvas>
  </div>
  <h1>The Universe</h1>
  <button id="openModal">New Post</button>
  <div id="modalBlur" class="modal-blur"></div>
  <div id="postModal" class="modal">
    <textarea id="newPostContent" placeholder="What's on your mind?"></textarea><br/>
    <input type="file" id="postImageUpload" accept="image/*"/><br/>
    <button id="postButton">Post</button>
    <button id="closeModal">Cancel</button>
  </div>
  <div id="postsContainer"></div>
  <script>
    // === ERROR BANNER ===
    function showErrorBanner(msg) {
      const b = document.getElementById('errorBanner');
      b.innerText = msg;
      b.style.display = 'block';
      setTimeout(() => { b.style.display = 'none'; }, 6000);
    }
    window.onerror = function(msg, url, line, col, error) {
      showErrorBanner('ERROR: ' + msg);
      return false;
    };

    // === STAR FIELD ===
    const starCanvas = document.getElementById('star-bg');
    const ctx = starCanvas.getContext('2d');
    function resizeStarCanvas() {
      starCanvas.width = window.innerWidth;
      starCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeStarCanvas);
    resizeStarCanvas();
    function drawStars() {
      ctx.clearRect(0,0,starCanvas.width,starCanvas.height);
      let numStars = Math.floor(window.innerWidth * window.innerHeight / 1400);
      for (let i=0; i<numStars; i++) {
        let x = Math.random()*starCanvas.width;
        let y = Math.random()*starCanvas.height;
        let r = Math.random()*1.2 + 0.3;
        let o = Math.random()*0.8+0.18;
        ctx.beginPath();
        ctx.arc(x,y,r,0,2*Math.PI);
        ctx.fillStyle = `rgba(255,255,255,${o})`;
        ctx.shadowColor = '#fff';
        ctx.shadowBlur = r*3;
        ctx.fill();
        ctx.closePath();
      }
    }
    drawStars();
    setInterval(drawStars, 4000);

    // ---- 3D Globe ----
    const canvas = document.getElementById("globeCanvas");
    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
    renderer.setSize(400, 400);
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
    camera.position.z = 3;
    const textureLoader = new THREE.TextureLoader();
    const earthTexture = textureLoader.load("https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg");
    const sphere = new THREE.Mesh(
      new THREE.SphereGeometry(1, 32, 32),
      new THREE.MeshStandardMaterial({ map: earthTexture })
    );
    scene.add(sphere);
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 3, 5);
    scene.add(light);
    function animate() {
      requestAnimationFrame(animate);
      sphere.rotation.y += 0.002;
      renderer.render(scene, camera);
    }
    animate();

    // === FEED & POST LOGIC ===
    const currentUsername = "Marilyn"; // Change as needed
    const currentUserAvatar = "https://randomuser.me/api/portraits/women/44.jpg"; // Change as needed
    const firebaseConfig = {
      apiKey: "AIzaSyBT7P7DAfV-I9ESe6f9Jdp5ioCyGIK0d9A",
      authDomain: "hashhumanity-58b9a.firebaseapp.com",
      databaseURL: "https://hashhumanity-58b9a-default-rtdb.firebaseio.com",
      projectId: "hashhumanity-58b9a",
      storageBucket: "hashhumanity-58b9a.appspot.com",
      messagingSenderId: "886745899016",
      appId: "1:886745899016:web:2b0f7e043c2434379d71bd"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();
    const postsContainer = document.getElementById("postsContainer");

    function displayPost(postId, data) {
      const postElement = document.createElement("div");
      postElement.className = "post-item";
      // Header
      const header = document.createElement("div");
      header.className = "post-header";
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = data.avatar || "https://randomuser.me/api/portraits/men/32.jpg";
      header.appendChild(avatar);
      const userSpan = document.createElement("span");
      userSpan.className = "post-user";
      userSpan.textContent = data.username || "Unknown";
      header.appendChild(userSpan);
      const dateSpan = document.createElement("span");
      dateSpan.className = "post-date";
      dateSpan.textContent = " • " + new Date(data.timestamp).toLocaleString();
      header.appendChild(dateSpan);
      postElement.appendChild(header);
      // Content
      const text = document.createElement("div");
      text.style.margin = "12px 0 0 0";
      text.innerHTML = data.content || "";
      postElement.appendChild(text);
      // Image
      if (data.imageUrl) {
        const postImg = document.createElement("img");
        postImg.src = data.imageUrl;
        postImg.className = "uploaded";
        postElement.appendChild(postImg);
      }
      // Actions
      const actions = document.createElement("div");
      actions.className = "post-actions";
      const likeBtn = document.createElement("button");
      likeBtn.className = "like-btn";
      likeBtn.innerHTML = "&#10084;";
      let likes = data.likes || {};
      let likeCount = Object.keys(likes).length;
      if (likes[currentUsername]) likeBtn.classList.add("liked");
      const likeCountSpan = document.createElement("span");
      likeCountSpan.textContent = likeCount > 0 ? likeCount : "";
      likeBtn.onclick = () => {
        const userLiked = !!(likes && likes[currentUsername]);
        db.ref("posts/" + postId + "/likes/" + currentUsername).set(userLiked ? null : true);
      };
      actions.appendChild(likeBtn);
      actions.appendChild(likeCountSpan);
      if (data.username === currentUsername) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = "&#128465;";
        deleteBtn.onclick = () => {
          if (confirm("Delete this post?")) {
            db.ref("posts/" + postId).remove();
          }
        };
        actions.appendChild(deleteBtn);
      }
      postElement.appendChild(actions);
      postsContainer.appendChild(postElement);
    }

    // Fetch & render all posts, newest first
// Fetch & render all posts, newest first
    db.ref("posts").on("value", (snapshot) => {
      postsContainer.innerHTML = "";
      const posts = [];
      snapshot.forEach((child) => {
        posts.push({ id: child.key, ...child.val() });
      });
      posts.sort((a, b) => b.timestamp - a.timestamp);
      for (const post of posts) displayPost(post.id, post);
    });

    // === MODAL POPUP LOGIC ===
    const openModalBtn = document.getElementById("openModal");
    const postModal = document.getElementById("postModal");
    const modalBlur = document.getElementById("modalBlur");
    const closeModalBtn = document.getElementById("closeModal");

    function showModal() {
      modalBlur.classList.add("active");
      postModal.classList.add("active");
      postModal.focus();
    }
    function hideModal() {
      modalBlur.classList.remove("active");
      postModal.classList.remove("active");
      document.getElementById("newPostContent").value = "";
      document.getElementById("postImageUpload").value = "";
    }
    openModalBtn.addEventListener("click", showModal);
    closeModalBtn.addEventListener("click", hideModal);
    modalBlur.addEventListener("click", hideModal);
    document.addEventListener('keydown', e => {
      if (postModal.classList.contains("active") && e.key === "Escape") hideModal();
    });

    // === POST CREATION (with image upload) ===
    let postInProgress = false;
    document.getElementById("postButton").addEventListener("click", async () => {
      if (postInProgress) return;
      postInProgress = true;
      const btn = document.getElementById("postButton");
      btn.disabled = true;
      btn.textContent = "Posting...";
      const content = document.getElementById("newPostContent").value.trim();
      const file = document.getElementById("postImageUpload").files[0];
      if (!content && !file) {
        showErrorBanner("Please add text or select an image.");
        btn.disabled = false; btn.textContent = "Post"; postInProgress = false;
        return;
      }
      let imageUrl = "";
      try {
        if (file) {
          const imageRef = storage.ref("postImages/" + Date.now() + "_" + file.name);
          const snapshot = await imageRef.put(file);
          imageUrl = await snapshot.ref.getDownloadURL();
        }
        await db.ref("posts").push({
          content,
          imageUrl,
          timestamp: Date.now(),
          username: currentUsername,
          avatar: currentUserAvatar,
          likes: {}
        });
        hideModal();
      } catch (err) {
        showErrorBanner("Upload/post failed: " + err.message);
        console.error("Image upload failed or posting failed:", err);
      }
      btn.disabled = false; btn.textContent = "Post"; postInProgress = false;
    });
  </script>
</body>
</html>