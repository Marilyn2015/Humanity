<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>#HUMANITY Universe</title>
  <!-- Three.js for Globe Visualization -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.min.js"></script>
  <style>
    body { margin:0; padding:0; background:#080c19; color:#fff; font-family:'Roboto',sans-serif; overflow:hidden; }
    #star-bg, #globe-canvas { position:absolute; z-index:0; }
    #star-bg { top:0; left:0; width:100vw; height:100vh; }
    #globe-canvas { width:300px; height:300px; top:120px; left:50%; transform:translateX(-50%); pointer-events:none; }
    .tabs { position:absolute; top:16px; left:50%; transform:translateX(-50%); z-index:2; display:flex; gap:12px; }
    .tab { padding:14px 32px; background:linear-gradient(90deg,#00bfff,#ff0080); color:#fff; border:none; border-radius:8px; cursor:pointer; box-shadow:0 6px 16px rgba(0,191,255,0.6); transition:transform .2s, box-shadow .2s; }
    .tab:hover { transform:translateY(-4px); box-shadow:0 8px 20px rgba(255,0,128,0.7); }
    h1 { position:absolute; top:40px; width:100%; text-align:center; font-size:2.4rem; z-index:2; text-shadow:0 2px 4px rgba(0,0,0,0.5); }
    #openModal { position:absolute; top:440px; left:50%; transform:translateX(-50%); padding:14px 36px; background:linear-gradient(90deg,#00bfff,#ff0080); color:#fff; border:none; border-radius:8px; cursor:pointer; z-index:2; box-shadow:0 6px 16px rgba(0,191,255,0.6); transition:transform .2s, box-shadow .2s; }
    #openModal:hover { transform:translate(-50%,-6px); box-shadow:0 8px 20px rgba(255,0,128,0.7); }
    .modal-blur, .modal { position:absolute; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; }
    .modal-blur.active, .modal.active { display:flex; }
    .modal .content { background:rgba(30,38,47,0.95); padding:32px; border-radius:12px; max-width:600px; width:90%; color:#fff; display:flex; flex-direction:column; gap:24px; z-index:3; }
    .modal textarea, .modal input[type=file] { width:100%; padding:16px; border-radius:8px; border:1px solid #555; background:#2f3642; color:#fff; }
    .actions { display:flex; justify-content:space-between; gap:16px; }
    .actions button { flex:1; padding:12px 0; border:none; border-radius:8px; cursor:pointer; background:linear-gradient(90deg,#ff0080,#00bfff); color:#fff; transition:transform .2s, box-shadow .2s; }
    .actions button:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,191,255,0.7); }
    #postsContainer { position:relative; margin-top:520px; padding:20px; overflow-y:auto; z-index:2; }
    .post-item { background:#2e2e2e; padding:16px; margin:12px auto; max-width:480px; border-radius:8px; box-shadow:0 4px 18px #00f6ff7a; }
    .post-item img { max-width:100%; margin-top:12px; border-radius:4px; }
    #errorOverlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); color:#f66; display:none; align-items:center; justify-content:center; text-align:left; padding:20px; font-size:1rem; z-index:5; }
    #errorOverlay pre { background:#222; padding:12px; border-radius:4px; overflow:auto; }
  </style>
</head>
<body>
  <canvas id="star-bg"></canvas>
  <canvas id="globe-canvas"></canvas>
  <div class="tabs">
    <button class="tab">Profile</button>
    <button class="tab" id="logoutBtn">Logout</button>
  </div>
  <h1>The Universe</h1>
  <button id="openModal">New Post</button>
  <div id="modalBlur" class="modal-blur"></div>
  <div id="postModal" class="modal">
    <div class="content">
      <textarea id="newPostContent" placeholder="What's on your mind? (max 280 chars)"></textarea>
      <input type="file" id="postImageUpload" accept="image/*" />
      <div class="actions">
        <button id="closeModal">Cancel</button>
        <button id="postButton">Post</button>
      </div>
    </div>
  </div>
  <div id="postsContainer"></div>
  <div id="errorOverlay">
    <p><strong>Permission Denied</strong></p>
    <p>Your Firebase rules are blocking writes. To fix this, update your Realtime Database rules under <code>posts</code> to allow authenticated users:</p>
    <pre>{
  "rules": {
    "posts": {
      ".read":  "auth != null",
      ".write": "auth != null"
    }
  }
}</pre>
    <p>And ensure <strong>Anonymous Authentication</strong> is enabled in the Firebase Console under Authentication â†’ Sign-in method.</p>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.module.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getDatabase, ref, push, query, orderByChild, onValue } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

    // Starfield Initialization
    const sCanvas = document.getElementById('star-bg'), gCanvas = document.getElementById('globe-canvas');
    const sCtx = sCanvas.getContext('2d');
    function resize() { sCanvas.width = window.innerWidth; sCanvas.height = window.innerHeight; gCanvas.width = 300; gCanvas.height = 300; }
    window.addEventListener('resize', resize); resize();
    const stars = Array.from({ length: 200 }, () => ({ x: Math.random() * sCanvas.width, y: Math.random() * sCanvas.height, r: Math.random() * 1.2 + 0.3, base: Math.random() * 0.5 + 0.2, phase: Math.random() * Math.PI * 2 }));
    (function drawStars() {
      sCtx.clearRect(0, 0, sCanvas.width, sCanvas.height);
      const t = Date.now() * 0.002;
      stars.forEach(st => {
        sCtx.globalAlpha = st.base + Math.sin(t + st.phase) * 0.1;
        sCtx.beginPath();
        sCtx.arc(st.x, st.y, st.r, 0, 2 * Math.PI);
        sCtx.fillStyle = '#fff';
        sCtx.fill();
      });
      requestAnimationFrame(drawStars);
    })();

    // Globe Initialization
    (function initGlobe() {
      const renderer = new THREE.WebGLRenderer({ canvas: gCanvas, alpha: true });
      renderer.setSize(300, 300);
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
      camera.position.z = 3;
      const light = new THREE.DirectionalLight(0xffffff, 1); light.position.set(5, 3, 5); scene.add(light);
      new THREE.TextureLoader().load('https://marilyn2015.github.io/Humanity/earthmap1k.jpg', tex => {
        const sphere = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), new THREE.MeshStandardMaterial({ map: tex })); scene.add(sphere);
        (function animate() { requestAnimationFrame(animate); sphere.rotation.y += 0.005; renderer.render(scene, camera); })();
      });
    })();

    // Firebase Configuration
    const firebaseConfig = { apiKey: "AIzaSyBT7P7DAfV-I9ESe6f9Jdp5ioCyGIK0d9A", authDomain: "hashhumanity-58b9a.firebaseapp.com", databaseURL: "https://hashhumanity-58b9a-default-rtdb.firebaseio.com", projectId: "hashhumanity-58b9a", storageBucket: "hashhumanity-58b9a.appspot.com", messagingSenderId: "886745899016", appId: "1:886745899016:web:2b0f7e043c2434379d71bd", measurementId: "G-3ZTCXL4374" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const postsRef = ref(db, 'posts');
    const errorOverlay = document.getElementById('errorOverlay');

    // Enable anonymous authentication
    signInAnonymously(auth).catch(err => { console.error('Auth error:', err); errorOverlay.style.display = 'flex'; });
    onAuthStateChanged(auth, user => { if (!user) return; setupPosts(); setupModal(); });

    // Load all posts
    function setupPosts() {
      const container = document.getElementById('postsContainer');
      const postsQuery = query(postsRef, orderByChild('timestamp'));
      onValue(postsQuery, snapshot => {
        container.innerHTML = '';
        snapshot.forEach(child => {
          const d = child.val();
          const el = document.createElement('div'); el.className = 'post-item';
          el.innerHTML = `<strong>${d.username}</strong> <em>${new Date(d.timestamp).toLocaleString()}</em><p>${d.content}</p>${d.imageUrl ? `<img src="${d.imageUrl}"/>` : ''}`;
          container.prepend(el);
        });
      }, err => { console.error('DB read error:', err); errorOverlay.style.display = 'flex'; });
    }

    // Modal and logout setup
    function setupModal() {
      const openBtn = document.getElementById('openModal');
      const blur = document.getElementById('modalBlur');
      const modal = document.getElementById('postModal');
      const closeBtn = document.getElementById('closeModal');
      const logoutBtn = document.getElementById('logoutBtn');
      openBtn.onclick = () => { blur.classList.add('active'); modal.classList.add('active'); openBtn.style.display = 'none'; };
      closeBtn.onclick = resetModal;
      blur.onclick = resetModal;
      document.getElementById('postButton').onclick = postNew;
      logoutBtn.onclick = () => { window.location.href = 'index.html'; };
    }

    // Post submission
    async function postNew() {
      const content = document.getElementById('newPostContent').value.trim();
      const file = document.getElementById('postImageUpload').files[0];
      if (!content && !file) return;
      try {
        let imageUrl = '';
        if (file) {
          const fRef = storageRef(storage, `posts/${Date.now()}_${file.name}`);
          await uploadBytes(fRef, file);
          imageUrl = await getDownloadURL(fRef);
        }
        const ts = Date.now();
        const pd = { username: 'Marilyn', content, imageUrl, timestamp: ts };
        await push(postsRef, pd);
        addPostToDOM(pd);
        resetModal();
      } catch (err) {
        console.error('Write error:', err);
        errorOverlay.style.display = 'flex';
      }
    }

    // Utility to append post
    function addPostToDOM({ username, content, imageUrl, timestamp }) {
      const container = document.getElementById('postsContainer');
      const el = document.createElement('div'); el.className = 'post-item';
      el.innerHTML = `<strong>${username}</strong> <em>${new Date(timestamp).toLocaleString()}</em><p>${content}</p>${imageUrl ? `<img src="${imageUrl}"/>` : ''}`;
      container.prepend(el);
    }

    // Reset modal
    function resetModal() {
      document.getElementById('newPostContent').value = '';
      document.getElementById('postImageUpload').value = '';
      document.getElementById('modalBlur').classList.remove('active');
      document.getElementById('postModal').classList.remove('active');
      document.getElementById('openModal').style.display = 'block';
    }
  </script>
</body>
</html>
