<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>#HUMANITY Universe</title>
  <!-- Three.js for Globe Visualization -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.min.js"></script>
  <style>
    body { margin:0; background:#080c19; color:#fff; font-family:'Roboto',sans-serif; overflow:hidden; }
    #star-bg, #globe-canvas { position:absolute; z-index:0; }
    #star-bg { top:0; left:0; width:100vw; height:100vh; }
    #globe-canvas { width:300px; height:300px; top:120px; left:50%; transform:translateX(-50%); pointer-events:none; }
    .button-bar { position:absolute; top:24px; left:50%; transform:translateX(-50%); display:flex; gap:16px; z-index:2; }
    .button-bar button { padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid #555; color:#fff; border-radius:4px; cursor:pointer; transition:background .3s,box-shadow .3s; }
    .button-bar button:hover { background:rgba(255,255,255,0.2); box-shadow:0 0 12px rgba(255,255,255,0.4); }
    .centered-new-post { position:absolute; top:440px; left:50%; transform:translateX(-50%); z-index:2; }
    .centered-new-post button { padding:14px 28px; background:rgba(255,255,255,0.1); border:1px solid #555; color:#fff; border-radius:4px; cursor:pointer; transition:background .3s,box-shadow .3s; }
    .centered-new-post button:hover { background:rgba(255,255,255,0.2); box-shadow:0 0 12px rgba(255,255,255,0.4); }
    .overlay, .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:5; }
    .overlay.active, .modal.active { display:flex; }
    .overlay { backdrop-filter:blur(12px); background:rgba(0,0,0,0.6); }
    .modal-box { background:#1c1c1e; padding:32px; width:90%; max-width:480px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.8); display:flex; flex-direction:column; align-items:center; gap:24px; position:relative; }
    .modal-box::before { content:'New Post'; position:absolute; top:-20px; background:#1c1c1e; padding:4px 12px; border-radius:4px; color:#0ef8; border:1px solid #0ef8; font-size:1.1rem; }
    .modal-box textarea { width:100%; min-height:120px; background:#242428; color:#fff; border:none; border-radius:6px; padding:12px; font-size:1rem; resize:vertical; outline:none; }
    .modal-box input[type=file] { width:100%; padding:12px; background:#242428; color:#fff; border:1px dashed #555; border-radius:6px; cursor:pointer; }
    .modal-box .footer { display:flex; gap:12px; width:100%; }
    .modal-box .footer button { flex:1; padding:12px; border:none; border-radius:6px; background:#0ef8; color:#080c19; font-weight:700; cursor:pointer; transition:background .3s,box-shadow .3s; }
    .modal-box .footer button.cancel { background:transparent; color:#aaa; border:1px solid #555; }
    .modal-box .footer button:hover { background:#0af0; box-shadow:0 0 16px rgba(14,248,255,0.6); }
    .post-container { position:absolute; top:520px; left:50%; transform:translateX(-50%); width:90%; max-width:600px; z-index:1; display:flex; flex-direction:column; gap:12px; }
    .post { background:#242428; border:1px solid #333; padding:16px; border-radius:6px; color:#ddd; }
    .post-time { font-size:0.75rem; color:#888; margin-bottom:8px; }
    .post img { max-width:100%; margin-top:12px; border-radius:6px; }
  </style>
</head>
<body>
  <canvas id="star-bg"></canvas>
  <canvas id="globe-canvas"></canvas>

  <div class="button-bar">
    <button onclick="location.href='create_profile.html'">Create Profile</button>
    <button onclick="location.href='index.html'">Log Out</button>
  </div>

  <div class="centered-new-post"><button onclick="openModal()">New Post</button></div>
  <div class="overlay" id="overlay"></div>
  <div class="modal" id="postModal">
    <div class="modal-box">
      <textarea id="postContent" placeholder="What's on your mind?"></textarea>
      <input type="file" id="postImage" accept="image/*" />
      <div class="footer">
        <button class="cancel" onclick="closeModal()">Cancel</button>
        <button id="postButton">Post</button>
      </div>
    </div>
  </div>

  <div class="post-container" id="postFeed"></div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.module.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getDatabase, ref as dbRef, push, onValue } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBT7P7DAfV-I9ESe6f9Jdp5ioCyGIK0d9A",
      authDomain: "hashhumanity-58b9a.firebaseapp.com",
      databaseURL: "https://hashhumanity-58b9a-default-rtdb.firebaseio.com",
      projectId: "hashhumanity-58b9a",
      storageBucket: "hashhumanity-58b9a.appspot.com",
      messagingSenderId: "886745899016",
      appId: "1:886745899016:web:2f0f7e043c2434379d71bd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Redirect to profile creation if not authenticated
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = 'create_profile.html';
      } else {
        setupModal();
        setupPosts();
      }
    });

    function setupModal() {
      window.openModal = () => {
        document.getElementById('overlay').classList.add('active');
        document.getElementById('postModal').classList.add('active');
      };
      window.closeModal = () => {
        document.getElementById('overlay').classList.remove('active');
        document.getElementById('postModal').classList.remove('active');
      };
      document.getElementById('postButton').addEventListener('click', async () => {
        const content = document.getElementById('postContent').value.trim();
        const fileEl = document.getElementById('postImage');
        let imageUrl = '';
        if (fileEl.files.length) {
          const file = fileEl.files[0];
          const path = `posts/${Date.now()}_${file.name}`;
          const ref = storageRef(storage, path);
          await uploadBytes(ref, file);
          imageUrl = await getDownloadURL(ref);
        }
        if (!content && !imageUrl) return;
        await push(dbRef(db, 'posts'), { content, imageUrl, timestamp: Date.now() });
        document.getElementById('postContent').value = '';
        fileEl.value = '';
        closeModal();
      });
    }

    function setupPosts() {
      const postsRef = dbRef(db, 'posts');
      onValue(postsRef, snapshot => {
        const feed = document.getElementById('postFeed');
        feed.innerHTML = '';
        const data = snapshot.val() || {};
        Object.entries(data).sort(([,a],[,b]) => b.timestamp - a.timestamp).forEach(([, post]) => {
          const div = document.createElement('div');
          div.className = 'post';
          div.innerHTML = `
            <div class="post-time">${new Date(post.timestamp).toLocaleString()}</div>
            <div class="post-content">${post.content}</div>
            ${post.imageUrl ? `<img src="${post.imageUrl}"/>` : ''}
          `;
          feed.appendChild(div);
        });
      });
    }

    // Starfield Animation
    const starCanvas = document.getElementById('star-bg');
    const starCtx = starCanvas.getContext('2d');
    function resizeStars() {
      starCanvas.width = window.innerWidth;
      starCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeStars);
    resizeStars();
    const stars = Array.from({ length: 200 }, () => ({ x: Math.random()*starCanvas.width, y: Math.random()*starCanvas.height, r: Math.random()*1.2+0.3, base: Math.random()*0.5+0.2, phase: Math.random()*2*Math.PI }));
    (function animateStars() {
      const t = Date.now()*0.002;
      starCtx.clearRect(0,0,starCanvas.width,starCanvas.height);
      stars.forEach(s => {
        starCtx.globalAlpha = s.base + Math.sin(t + s.phase)*0.1;
        starCtx.beginPath();
        starCtx.arc(s.x, s.y, s.r, 0, 2*Math.PI);
        starCtx.fillStyle = '#fff';
        starCtx.fill();
      });
      requestAnimationFrame(animateStars);
    })();

    // Globe Visualization
    const globeCanvas = document.getElementById('globe-canvas');
    const renderer = new THREE.WebGLRenderer({ canvas: globeCanvas, alpha:true });
    renderer.setSize(300,300);
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50,1,0.1,1000);
    camera.position.z = 3;
    const light = new THREE.DirectionalLight(0xffffff,1);
    light.position.set(5,3,5);
    scene.add(light);
    new THREE.TextureLoader().load('https://marilyn2015.github.io/Humanity/earthmap1k.jpg', texture => {
      const sphere = new THREE.Mesh(
        new THREE.SphereGeometry(1,32,32),
        new THREE.MeshStandardMaterial({ map: texture })
      );
      scene.add(sphere);
      function render() {
        requestAnimationFrame(render);
        sphere.rotation.y += 0.005;
        renderer.render(scene, camera);
      }
      render();
    });
  </script>
</body>
</html>
